<style>*{text-align:center}li{text-align:left}.hidden{visibility:hidden}div#app{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%)}div.status{margin:10px 0}.progressBar{width:240px;height:10px;border-radius:10px;background:#eee}.doneBar{width:0;height:inherit;border-radius:10px;background:linear-gradient(90deg,#fd0,#f20);transition:width .3s}div#current p{color:grey}</style><div id=app><div id=page1><h2>即将删除您的部分犇犇。</h2><h4>在进行操作前，请确保知晓该犇犇删除脚本的使用事项。</h4><ul><li>请注意，此程序会将所有的普通犇犇（即在主页主动发送的犇犇）删除， 但您可以决定是否删除系统犇犇（即系统根据您的发帖、发博客、参加比赛生成的犇犇）。<li>在代码运行时发送或手动删除犇犇可能会导致漏删或效率降低。<li>在正常操作的情况下，保证不会危害您的账号和计算机安全。</ul><h4>您可以通过修改以下选项来满足您的需求。</h4><div><input checked id=sys type=checkbox><label for=sys>删除系统消息</label></div><hr><button id=startButton>开始删除</button></div><div id=page2 style=display:none><h2>正在删除您的犇犇。</h2><h4>进度：</h4><div id=normalStatus>已删除普通犇犇： <span id=normalCurShow>?</span> / <span id=normalSumShow>?</span><div class=progressBar><div id=normalProgress class=doneBar></div></div></div><div id=sysStatus class=status>已删除系统犇犇： <span id=sysCurShow>?</span> / <span id=sysSumShow>?</span><div class=progressBar><div id=sysProgress class=doneBar></div></div></div><div id=time class=status>目前所用时间： <span id=timeShow>0</span> 秒</div><h4>状态：</h4><div id=current class=status><p class=hidden>.<p class=hidden>.<p class=hidden>.</div><hr><button id=pauseButton>暂停</button></div><div id=page3 style=display:none><h2>已删除您的犇犇。</h2><div id=result>删除了 <span id=normalRes></span> 条普通犇犇和 <span id=sysRes></span> 条系统犇犇，共 <span id=sumRes></span> 条，用时 <span id=timeRes></span> 秒。</div><hr><button onclick=location.reload()>回到主页</button></div></div><script>(()=>{Array.prototype.asyncForEach=async function(e){for(let t=0;t<this.length;++t)await e(this[t],t)};const e=300,t=_feInjection.currentUser.uid;function n(e){return new Promise((t=>{setTimeout((()=>{l?d=t:t()}),e)}))}function a(e){return new Promise((t=>{$.post(`/api/feed/delete/${e}`,(e=>{t(200===e.status)})).fail((()=>{t(!1)}))}))}let r,i,o=0,s=0,c=0,u=0,w=0,f=0,l=!1,d=null;const g=$("<div></div>");function h(){return new Promise((e=>{$.get(`/api/feed/list?user=${t}`,(t=>{s=t.feeds.count+o,e(t.feeds.result)})).fail((()=>{e(!1)}))}))}function y(e){return new Promise((t=>{$.get(`/feed/my?page=${e}`,(e=>{g.html(e);const n=g.find('a[name="feed-delete"]').map(((e,t)=>t.dataset.feedId)).toArray();g.html(""),t(n)})).fail((()=>{t(!1)}))}))}async function m(){let t=0,a=[],r=[];E("获取系统犇犇..."),F("grey");do{++t,await n(e),T(`获取系统犇犇第 ${t} 页...`),F("grey"),r=await y(t);let i=0;for(;!r;)++i,T(`获取系统犇犇第 ${t} 页：失败 ${i} 次`),F("orange"),await n(e),r=await y(t);a=a.concat(r)}while(r.length>0);return u+=a.length,E("获取系统犇犇：成功"),F("green"),a}async function p(){E("开始删除..."),F("green");const t=$("input#sys").prop("checked");await async function(){E("普通犇犇删除：开始"),F("green");let t=[],r=0;for(await n(e),E("获取普通犇犇列表..."),F("grey"),t=await h();!t;)++r,T(`获取普通犇犇列表：失败 ${r} 次`),F("orange"),await n(e),t=await h();for(R(),T("获取普通犇犇列表：成功"),F("green");t.length;){for(await t.asyncForEach((async t=>{for(r=0;r<=3;){if(await n(e),E(`删除犇犇 ${t.id}...`),F("grey"),await a(t.id))return++o,R(),T(`删除犇犇 ${t.id}：成功`),void F("green");++r,T(`删除犇犇 ${t.id}：失败 ${r} 次`),F("orange")}T(`删除犇犇 ${t.id}：暂时跳过`),F("red")})),await n(e),E("获取普通犇犇列表..."),F("grey"),t=await h(),r=0;!t;)++r,T(`获取普通犇犇列表：失败 ${r} 次`),F("orange"),await n(e),t=await h();R(),T("获取普通犇犇列表：成功"),F("green")}E(`删除普通犇犇 ${s} 条：成功`),F("green")}(),t&&await async function(){E("删除系统犇犇：开始"),F("green");let t=[],r=0;for(await n(e),t=await m(),D();t.length;)t.asyncForEach((async t=>{for(E(`删除犇犇 ${t}...`),F("grey"),r=0;r<=3;){if(await n(e),await a(t))return++c,D(),T(`删除犇犇 ${t}：成功`),void F("green");++r,T(`删除犇犇 ${t}：失败 ${r} 次`),F("orange")}T(`删除犇犇 ${t}：暂时跳过`),F("red")})),await n(e),t=await m(),D();E(`删除系统犇犇 ${u} 条：成功`),F("green")}(),E("完成删除！"),F("green"),S(),await n(1e3),$("#normalRes").text(s),$("#sysRes").text(u),$("#sumRes").text(s+u),$("#timeRes").text(w/1e3|0),$("#page2").hide(),$("#page3").show()}function x(){$("#timeShow").text((Date.now()-f+w)/1e3|0)}function P(){f=Date.now(),r=setTimeout((()=>{x(),i=setInterval(x,1e3)}),1e3-w%1e3)}function S(){x(),w+=Date.now()-f,clearTimeout(r),clearInterval(i)}const v=$("#startButton"),k=$("#pauseButton"),I=$("#current");function R(){$("#normalCurShow").text(o),$("#normalSumShow").text(s),s?$("#normalProgress").css("width",o/s*100+"%"):$("#normalProgress").css("width","100%")}function D(){$("#sysCurShow").text(c),$("#sysSumShow").text(u),u?$("#sysProgress").css("width",c/u*100+"%"):$("#sysProgress").css("width","100%")}function E(e){I.children(":last").remove(),I.prepend($(`<p>${e}</p>`))}function F(e){I.children(":first").css("color",e)}function T(e){I.children(":first").text(e)}v.click((()=>{$("input#sys").prop("checked")||$("#sysStatus").hide(),$("#page1").hide(),$("#page2").show(),p(),P()})),k.click((()=>{l?(k.text("暂停"),l=!1,d&&d(),P()):(k.text("继续"),l=!0,d=null,S())}))})()</script>
